<HTML>
<HEAD>
<TITLE>Stage3d Example</TITLE>
<META http-equiv="Content-Type" content="text/html;charset=UTF-8">
<LINK rel="stylesheet" href='../../acs/lang_cn.css' type="text/css" media="all"/>
<SCRIPT language='javascript' src='../../ajs/mo-core.js'></SCRIPT>
<SCRIPT language='javascript' src='../../ajs/mo-graphic.js'></SCRIPT>
<SCRIPT language='javascript' src='../../ajs/mo-engine.js'></SCRIPT>
<SCRIPT language='javascript' src='../../ajs/engine-3d-res.js'></SCRIPT>
<SCRIPT language='javascript' src='../../ajs/control.js'></SCRIPT>
<SCRIPT language='javascript' src='../../ajs/stage.js'></SCRIPT>
<SCRIPT language='javascript' src='../../ajs/context_cn.js'></SCRIPT>

<SCRIPT language='javascript' src='../../6-engine-3d-resource/FRs3Resource.js'></SCRIPT>
<SCRIPT language='javascript' src='../../6-engine-3d-resource/FRs3VertexBuffer.js'></SCRIPT>
<SCRIPT language='javascript' src='../../6-engine-3d-resource/FRs3IndexBuffer.js'></SCRIPT>
<SCRIPT language='javascript' src='../../6-engine-3d-resource/FRs3Geometry.js'></SCRIPT>
<SCRIPT language='javascript' src='../../6-engine-3d-resource/FRs3Model.js'></SCRIPT>

<SCRIPT language='javascript' src='../../5-graphic-3d-wgl/FWglContext.js'></SCRIPT>
<SCRIPT language='javascript' src='../../5-graphic-3d-wgl/FWglProgram.js'></SCRIPT>
</HEAD>

<SCRIPT>
// http://localhost:999/test/engine3d/resource-001.html
var hc = null;

var context = null;
var program = null;
var mRotationX = 0;
var mRotationY = 0;
var mRotationZ = 0;
var mMatrix = null;
var vc_vp_matrix = null;
var cube = null;
var vertexPositionBuffer = null;
var indexBuffer = null;
var image = null;
var texture = null;

function onEnterFrame(){
   mMatrix.identity();
   //mMatrix.rotation(mRotationX, 0, 0);
   //mMatrix.rotation(0.5, 0, 0);
   mMatrix.setScale(1.5, 1.5, 1.5);
   mMatrix._ty = -3.5;
   //mMatrix._rx = mRotationX;
   mMatrix._ry = mRotationY;
   //mMatrix._rz = mRotationZ;
   mMatrix.updateForce();
   mRotationX += 0.01;
   mRotationY += 0.02;
   mRotationZ += 0.03;

   context.clear(0, 0, 0, 1, 1);
   context.setProgram(program);
   program.setAttribute('va_position', vertexPositionBuffer, ERenderAttributeFormat.Float3);
   program.setAttribute('va_color', vertexPositionBuffer, ERenderAttributeFormat.Float3);
   program.setParameter('vc_model_matrix', mMatrix.data(), 64);
   program.setParameter('vc_vp_matrix', vc_vp_matrix.data(), 64);
   program.setSampler('fs_diffuse', texture);
   context.drawTriangles(indexBuffer);
   context.present();
}

function _dataLoad(){
   var v = RClass.create(FDataView);
   v._endianCd = true;
   v.link(hc.outputData());

   var rm = RClass.create(FRs3Model);
   rm.unserialize(v);
   var g = rm.geometrys().get(0);
   var vb = g._vertexBuffers.get(0);
   var ib = g._indexBuffer;

   RDump.dump(rm, _dump);

   texture = context.createFlatTexture();
   texture.upload(image);
   //RDump.dump(texture, _dump);

   vertexPositionBuffer = context.createVertexBuffer();
   var indexData = new Float32Array(vb._data);
   vertexPositionBuffer.upload(new Float32Array(vb._data), vb._stride, vb._vertexCount);

   indexBuffer = context.createIndexBuffer();
   indexBuffer.upload(new Uint16Array(ib._data), ib._count);


   RStage.lsnsEnterFrame.register(null, onEnterFrame);
   RStage.start(20);
}

function _load(){
   RRuntime.processCd = EProcess.Debug;
   RBrowser.construct();

   var hCanvas = document.getElementById('_canvas');
   context = REngine3d.createContext(FWglContext, hCanvas);
   context.setViewPort(hCanvas.width, hCanvas.height);
   context.setDepthMode(true, ERenderDepthMode.LessEqual);
   context.setCullingMode(true, ERenderCullMode.Front);

   program = context.createProgram();
   var xc = RClass.create(FXmlConnection);
   var r = xc.send("http://localhost/script/test/engine3d/shader-sample.xml");
   program.loadConfig(r);
   program.build();
   program.link();


   image = new Image();
   image.onload = function(){
      hc = RClass.create(FHttpConnection);
      hc._asynchronous = true;
      hc.lsnsLoad.register(null, _dataLoad);
      //hc.send("http://localhost:999/assets/model/pvw.show.item.001.ser");
      hc.send("http://localhost/script/assets/model/pvw.show.item.001.ser");
      //RDump.dump(image, _dump);
   }
   image.src = 'http://localhost/script/test/engine3d/texture001.jpg'

   var rc = RClass.create(FRenderCamera);
   rc.position.set(0, 0, -10);
   rc.lookAt(0, 0, 0);
   rc.update();

   var rp = RClass.create(FRenderProjection);
   rp.width = hCanvas.width;
   rp.height = hCanvas.height;
   rp.update();

   mMatrix = new SMatrix3d();
   vc_vp_matrix = new SMatrix3d();
   vc_vp_matrix.append(rc.matrix);
   vc_vp_matrix.append(rp.matrix);
}
</SCRIPT>

<BODY scroll='auto' onload='_load()'>
<CANVAS id="_canvas" width="800" height="400"></CANVAS>
<DIV id='_dump'></DIV><br>
<DIV id='_msg'></DIV><br>
</BODY>

</HTML>